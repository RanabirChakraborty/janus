---
- assert:
    that:
      - project_root_folder is defined
      - downstream_project is defined
    quiet: True
    fail_msg: "Missing required parameters."

- set_fact:
    path_to_playbooks_dir: "{{ project_root_folder }}/playbooks"
    path_to_playbooks_dir_dest: "{{ downstream_project }}"

- name: "Load metadata on folder {{ path_to_playbooks_dir }}"
  ansible.builtin.stat:
    path: "{{ path_to_playbooks_dir }}"
  register: is_playbook_dir

- ansible.builtin.include_tasks: roles/janus/tasks/playbooks/rename_vars_and_namespace.yml
  when:
    - is_playbook_dir.stat.exists

- ansible.builtin.include_tasks: playbooks/update_playbooks.yml
  vars:
    root_folder: "{{ downstream_project }}/playbooks/"

- name: "Update all dependency to upstream collection '{{ upstream_namespace }}.*' to downstream's one '{{ downstream_namespace }}'."
  debug:
    msg: "TODO"

- name: "List all roles within {{ downstream_project }}/roles"
  ansible.builtin.find:
    paths: "{{ downstream_project }}/roles"
    recurse: no
    file_type: directory
  register: downstream_roles

- assert:
    that:
      - downstream_roles is defined
    quiet: True
    fail_msg: "Internal error, can't list roles within: {{ downstream_project }}/roles"

- ansible.builtin.include_tasks: roles/switch_role_dependency_to_downstream.yml
  vars:
    path_to_meta_main_yml: "{{ downstream_roles_file.path }}/meta/main.yml"
  loop: "{{ downstream_roles.files }}"
  loop_control:
    loop_var: downstream_roles_file
  when:
    - downstream_roles.files is defined
